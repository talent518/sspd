#!/opt/ssp/bin/php -q
<?php

echo 'help:',$_SERVER['argv'][0],' [servname]',PHP_EOL;
echo 'help:',$_SERVER['argv'][0],' <servname> [port]',PHP_EOL;
echo 'help:',$_SERVER['argv'][0],' <servname> <port> [user]',PHP_EOL;
echo 'help:',$_SERVER['argv'][0],' <servname> <port> <user> [nthreads]',PHP_EOL;
echo 'help:',$_SERVER['argv'][0],' <servname> <port> <user> <nthreads> [clients]',PHP_EOL;

$SSP_DIR=dirname(__FILE__);
$SERV_NAME=(($_SERVER['argc']>=2 && preg_match("/[a-z0-9-_]+/i",$_SERVER['argv'][1]))?$_SERVER['argv'][1]:'ssp');
$SERV_PORT=(($_SERVER['argc']>=3 && preg_match("/[0-9]+/i",$_SERVER['argv'][2]))?$_SERVER['argv'][2]:'8086');
$SERV_USER=(($_SERVER['argc']>=4 && preg_match("/[a-z0-9-_]+/i",$_SERVER['argv'][3]))?$_SERVER['argv'][3]:'daemon');
$SERV_NTHEADS=(($_SERVER['argc']>=5 && preg_match("/[0-9]+/i",$_SERVER['argv'][4]))?$_SERVER['argv'][4]:100);
$SERV_CLIENTS=(($_SERVER['argc']>=6 && preg_match("/[0-9]+/i",$_SERVER['argv'][5]))?$_SERVER['argv'][5]:1000);

is_dir($SSP_DIR.'/log') or mkdir($SSP_DIR.'/log',0755);
system('rm -f /etc/init.d/'.$SERV_NAME);

$content=file_get_contents('./ssp-serv');
$content=str_replace('{SSP_DIR}',$SSP_DIR,$content);
$content=str_replace('{SERV_NAME}',$SERV_NAME,$content);
$content=str_replace('{SERV_PORT}',$SERV_PORT,$content);
$content=str_replace('{SERV_USER}',$SERV_USER,$content);
$content=str_replace('{SERV_NTHEADS}',$SERV_NTHEADS,$content);
$content=str_replace('{SERV_CLIENTS}',$SERV_CLIENTS,$content);
$content=str_replace('{SERV_PIDFILE}','/var/run/'.$SERV_NAME.'.pid',$content);
file_put_contents('/etc/init.d/'.$SERV_NAME,$content);

system('chmod 773 /etc/init.d/'.$SERV_NAME);
system('chkconfig --add '.$SERV_NAME);
system('chkconfig --level 345 '.$SERV_NAME.' on');

if(file_exists('/etc/init.d/'.$SERV_NAME)){
	echo 'Install "',$SERV_NAME,'" completed.',PHP_EOL;
}else{
	echo 'Install "',$SERV_NAME,'" failed.',PHP_EOL;
}

?>
